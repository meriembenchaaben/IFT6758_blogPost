---
layout: post
title: MileStone 1
---

## Task 1: Warm-up 
#### Question 1
**What issues do you notice by using this metric to rank goalies?**


<img src="/assets/Milestone1_Task1_Question1.png" alt="">{:class="img-responsive"}

The top goalies, with highest save percentages (SV%), played few games without conceding goals. This metric favors goalies who played few games and faced few shots. It doesn't take into consideration the number of games played or the number of shots a goalie has faced.

Example: A goalie who faced three shots and saved them (SV%=1) would have a better save percentage than a goalie who faced 1620 shot and saved 1482 (SV%=1=0.915)

**What could be done to deal with this?**
To deal with this issue, we need to smooth the SV% metric with the number of shots a goalie has faced. We can also consider the number of games/wins of the goalie.


**The Goals Saved Above Average (GSAA)** is a metric that fairly compares goalies performance.

It measures the number of goals a particular goalie saved based on his save percentage and shots against him given the average of both of these categories across the league.
> GSAA = [Shots against x (1 – league-average save percentage)] – goals allowed 

A second option is to consider the number of games played  **(GP)** or the wins **(W)** and combine it with the save percentage **(SV%)**.
We suggest the following formula: 
> Score= SV%*W 

A high score requires that the goalie has won many games and has a good SV%. This penalizes goalies who played few games or has few wins which solves the problem seen in the first question.

#### Question 2
We present a bar plot with player names on the y-axis and save percentage (‘SV%’) on the x-axis, all filtred using our  proposed approach.  
<img src="/assets/Question1_2.png" alt="">{:class="img-responsive"}


#### Question 3


- **GP: Games Played**: A good goalie should have played several games to avoid the bias of having a high SV% while playing few games.
 
	
- **W: Wins**: The number of wins might be a good metric to judge the performance of goalies when coupled with other metrics.

	
- **L: Losses**: Following the smae logic explained previously, the golies could be penalized by using both **Losses** metric and *GA: Goals against* metric. 	

- **SA**	
- **SV**	
- **SV%**	
- **GAA**	
- **SO**	
- **GPS**	
- **MIN**	
- **QS**	
- **QS%**	
- **RBS**	
- **GA%-**	
- **GSAA**	
- **G**	
- **A**	
- **PTS**	
- **PIM**



## Task 2: Data Acquisition

We encapsulated all the logics responsible of downloading the NHL play-by-play data in a class called **NHL_API**.
When instantiated, we check in the constructor if a path to the dataset is specified, through the environment variable **DATASET_DIR_PATH**, otherwise we assign a default value.

```python
class NHL_API:
    
    def __init__(self):
        # Load dataset directory path from .env file
        load_dotenv('../.env')
        self.DATASET_DIR_PATH = os.getenv('DATASET_DIR_PATH')

        if (not self.DATASET_DIR_PATH):
            self.DATASET_DIR_PATH = 'dataset/'
```



To retrieve the data between 2 seasons, we need to call method **get_nhl_data** while specifing the start and end seasons (for the season *s/s+1*, the season argument should be *s*).
The method uses **get_nhl_season** to retrieve the data of each season and shows the progress of retrieving the data.

In the method **get_nhl_season**, we check if the data of a particular season already exists in local.
If it exists, it reads it from the local file and returns the results. Otherwise, it calls **get_nhl_regular** and **get_nhl_regular** respectively to retrieve the data of both regular season and playoffs for this season.

```python
    def get_nhl_data(self, start_season, end_season):
        """Return the NHL play-by-play data between two seasons.

        :param start_season: start season (start_season/start_season+1)
        :type a: int
        :param end_season: end season (end_season/end_season+1)
        :type b: int

        :rtype: list
        :return: NHL play-by-play data of all seasons between start_season and end_season
        """
        progress_bar = tqdm(range(start_season, end_season + 1))
        data = []
        for season in progress_bar:
            progress_bar.set_description(f'Retrieving NHL data for season {season}/{season + 1}')
            data.extend(self.get_nhl_season(season))
            progress_bar.set_description(f'Data saved to {self.DATASET_DIR_PATH}')

        return data


    def get_nhl_season(self, season):
        """Return the NHL play-by-play data for one season (regular season and playoffs)

        :param season: season (season/season+1)
        :type a: int

        :rtype: list
        :return: NHL play-by-play data of season/season+1
        """

        filepath = os.path.join(self.DATASET_DIR_PATH, f'data-{season}.npy')

        # check if the data already exists in local
        if os.path.exists(filepath):
            return np.load(filepath, allow_pickle=True)

        data = []
        data.extend(self.get_nhl_regular(season))
        data.extend(self.get_nhl_playoffs(season))

        # save the data in local for next usage     
        np.save(filepath, data)

        return data
```

The code below illustrates how we retrieved the data for both *regular season*  and *playoffs*.


```python
    def get_nhl_regular(self, season, game_type = 2):
        """Retrieve and return the NHL play-by-play data for a regular season.

        :param season: season (season/season+1)
        :type a: int
        :game_type: type index of regular season in the NHL Stats API 
        :type a: int

        :rtype: list
        :return: NHL play-by-play data of regular season (season/season+1)
        """

        nb_games = 868 if season == 2020 else 1271 if season > 2016 else 1230
        data=[]

        for i in range(nb_games):
            game_id = f'{season}{game_type:02}{i+1:04}'
            url = f'https://statsapi.web.nhl.com/api/v1/game/{game_id}/feed/live/'
            response = requests.get(url)

            if(response.status_code != 200):
                raise Exception('Error occured while retrieving data from NHL api!')

            data.append(response.json())
        return data


    def get_nhl_playoffs(self, season, game_type = 3): 
        """Retrieve and return the NHL play-by-play data for the playoffs of season/season+1.

        :param season: season (season/season+1)
        :type a: int
        :game_type: type index of playoffs in the NHL Stats API 
        :type a: int

        :rtype: list
        :return: NHL play-by-play data of playoffs (season/season+1)
        """

        data=[]
        nb_rounds = 4
        nb_games = 7

        for iround in range(nb_rounds):
            for matchup in range(pow(2, 3 - iround)):
                for game in range(7):
                    game_id = f'{season}{game_type:02}0{iround+1}{matchup+1}{game+1}'
                    url = f'https://statsapi.web.nhl.com/api/v1/game/{game_id}/feed/live/'
                    response = requests.get(url)

                    if(response.status_code != 200):          
                        continue

                    data.append(response.json())
        return data
```


## Task 3: Interactive Debugging Tool

## Task 4: Tidy Data

## Task 5: Simple Visualizations 

## Task 6: Advanced Visualizations: Shot Maps

